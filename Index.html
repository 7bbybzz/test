<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RakRunnin Shop - Stack Racks Fast</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    :root {
      --primary: #003087;
      --primary-hover: #005ea2;
      --accent: #f5c518;
      --bg: #0f172a;
      --card-bg: #1e293b;
      --text: #e2e8f0;
      --border: #334155;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      --transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      --radius: 16px;
    }
    [data-theme="light"] {
      --bg: #ffffff;
      --card-bg: #ffffff;
      --text: #1a252f;
      --border: #e0e0e0;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Roboto', sans-serif;
      overflow: hidden;
      transition: var(--transition);
      position: relative;
    }
    /* POPUP KEYFRAMES FIX */
    @keyframes popupIn {
      0% { opacity: 0; transform: translateY(20px) scale(0.9); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    /* CAPTCHA */
    #captcha-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(12px);
      z-index: 9999; display: flex; flex-direction: column;
      justify-content: center; align-items: center;
    }
    #captcha-screen h2 {
      font-size: 3rem; font-weight: 900; color: var(--accent); margin-bottom: 1rem;
      text-shadow: 0 0 20px rgba(245, 197, 24, 0.5);
    }
    #captcha-screen input {
      width: 260px; padding: 16px; margin: 16px 0;
      border: 2px solid var(--primary); border-radius: 12px;
      background: var(--card-bg); color: var(--text);
      font-size: 1.3rem; text-align: center;
    }
    #captcha-screen button {
      background: var(--primary); color: white; padding: 16px 40px;
      border: none; border-radius: 12px; font-weight: 700; cursor: pointer;
      transition: var(--transition); margin-top: 10px;
    }
    #captcha-screen button:hover {
      background: var(--primary-hover); transform: translateY(-3px) scale(1.05);
      box-shadow: 0 10px 30px rgba(0, 94, 162, 0.4);
    }
    /* PAGE SYSTEM */
    .page {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      display: none; opacity: 0; transform: translateY(40px);
      overflow-y: auto; padding: 20px;
      clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
      z-index: 1;
    }
    .page.active {
      display: block; opacity: 1; transform: translateY(0);
      animation: pageIn 0.6s ease forwards;
      z-index: 10;
    }
    @keyframes pageIn {
      to { clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%); }
    }
    /* CREDIT DISPLAY FIX */
    #credit-display {
      position: fixed; top: 18px; right: 80px;
      background: var(--accent); color: var(--primary);
      padding: 8px 16px; border-radius: 50px; font-size: 0.9rem;
      font-weight: 700; z-index: 100; box-shadow: 0 4px 12px rgba(245,197,24,0.4);
      display: none; align-items: center; gap: 8px;
    }
    /* HEADER */
    .header {
      text-align: center; padding: 30px 20px; background: linear-gradient(135deg, var(--primary), var(--primary-hover));
      color: white; border-radius: var(--radius); margin: 20px; box-shadow: var(--shadow);
    }
    .header h1 { font-size: 2.5rem; font-weight: 900; letter-spacing: 1px; }
    /* CARD SELECTOR */
    .card-selector {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px;
      margin: 30px 0;
    }
    .card-option {
      background: var(--card-bg); border: 2px solid transparent; border-radius: var(--radius);
      padding: 20px; text-align: center; cursor: pointer; transition: var(--transition);
      box-shadow: var(--shadow);
    }
    .card-option.selected {
      border-color: var(--accent); background: rgba(245, 197, 24, 0.1); transform: scale(1.05);
    }
    .card-option img { width: 80px; height: 50px; object-fit: contain; margin-bottom: 10px; }
    /* BALANCE TIERS */
    .tier-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px;
      margin: 20px 0;
    }
    .tier {
      background: var(--card-bg); border: 2px solid var(--border); border-radius: 12px;
      padding: 14px; text-align: center; cursor: pointer; transition: var(--transition);
    }
    .tier.selected {
      border-color: var(--accent); background: rgba(245, 197, 24, 0.15); transform: translateY(-4px);
    }
    /* QUANTITY */
    .qty-control {
      display: flex; align-items: center; justify-content: center; gap: 12px; margin: 20px 0;
    }
    .qty-btn {
      width: 40px; height: 40px; background: var(--primary); color: white;
      border: none; border-radius: 50%; font-size: 1.2rem; cursor: pointer;
    }
    /* CART */
    .cart-item {
      background: rgba(0, 48, 135, 0.1); padding: 16px; border-radius: 12px;
      margin: 12px 0; display: flex; justify-content: space-between; align-items: center;
    }
    /* INVOICE */
    .btc-invoice {
      background: linear-gradient(135deg, #1e293b, #0f172a); color: white;
      padding: 30px; border-radius: var(--radius); text-align: center; margin: 20px auto;
      max-width: 420px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    #qr-code { width: 180px; height: 180px; margin: 20px auto; background: white; padding: 10px; border-radius: 12px; }
    .copy-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
    /* ICONS */
    .menu-icon, .cart-icon, .theme-toggle {
      position: fixed; width: 50px; height: 50px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
      color: white; background: var(--primary); box-shadow: var(--shadow); cursor: pointer; z-index: 100;
    }
    .menu-icon { top: 18px; left: 18px; }
    .cart-icon { top: 18px; right: 18px; }
    .theme-toggle { bottom: 20px; right: 20px; }
    .cart-badge {
      position: absolute; top: -8px; right: -8px; background: #ef4444; color: white;
      font-size: 0.7rem; width: 20px; height: 20px; border-radius: 50%; display: flex;
      align-items: center; justify-content: center; animation: bounce 0.6s infinite;
    }
    @keyframes bounce { 0%,100% { transform: scale(1); } 50% { transform: scale(1.3); } }
    /* CREDIT OPTIONS */
    .credit-option {
      background: rgba(0,48,135,0.05); padding: 10px 18px; border-radius: 12px;
      font-weight: 700; cursor: pointer; transition: var(--transition); border: 1px solid transparent;
      min-width: 90px;
    }
    .credit-option:hover, .credit-option.active {
      background: var(--primary); color: white; border-color: var(--accent); transform: translateY(-2px);
    }
  </style>
</head>
<body>

  <!-- CAPTCHA -->
  <div id="captcha-screen">
    <h2>STACK RACKS</h2>
    <p id="captcha-question">What is 7 + 5?</p>
    <input type="text" id="captcha-input" placeholder="Answer" autofocus>
    <button onclick="verifyCaptcha(event)">VERIFY</button>
    <p style="margin-top:20px;font-size:0.9rem;color:#94a3b8;">(Dev: Hold Shift + Click to Bypass)</p>
  </div>

  <!-- PAGES -->
  <div id="account-page" class="page">
    <div class="header"><h1>ACCESS PORTAL</h1></div>
    <div style="max-width:420px;margin:40px auto;background:var(--card-bg);padding:30px;border-radius:var(--radius);box-shadow:var(--shadow);">
      <input type="text" id="username-input" placeholder="Username" style="width:100%;padding:14px;margin:10px 0;border:2px solid var(--border);border-radius:12px;background:var(--bg);color:var(--text);">
      <input type="password" id="password-input" placeholder="Password" style="width:100%;padding:14px;margin:10px 0;border:2px solid var(--border);border-radius:12px;background:var(--bg);color:var(--text);">
      <button onclick="createAccount()" style="width:100%;padding:14px;margin:10px 0;background:var(--primary);color:white;border:none;border-radius:12px;font-weight:700;cursor:pointer;">CREATE</button>
      <button onclick="login()" style="width:100%;padding:14px;margin:10px 0;background:var(--accent);color:var(--primary);border:none;border-radius:12px;font-weight:700;cursor:pointer;">LOGIN</button>
    </div>
  </div>

  <div id="credits-page" class="page">
    <!-- CREDIT DISPLAY FIX: ADDED HERE -->
    <div class="credit-display" id="credit-display" style="display:none;">
      <i class="fas fa-coins"></i> $<span id="credit-amount">0.00</span>
    </div>
    <div class="header"><h1>REDEEM CREDITS</h1></div>
    <div style="max-width:460px;margin:30px auto;background:var(--card-bg);padding:30px;border-radius:var(--radius);box-shadow:var(--shadow);text-align:center;">
      <p>Minimum $25 to shop. Add more anytime.</p>
      <div style="display:flex;justify-content:center;align-items:center;gap:12px;margin:16px 0;">
        <input type="number" id="credit-input" placeholder="25.00" min="25" step="0.01" style="width:160px;padding:12px;border:2px solid var(--border);border-radius:12px;text-align:center;background:var(--bg);color:var(--text);">
        <button onclick="addCredit()" style="padding:12px 24px;background:var(--primary);color:white;border:none;border-radius:12px;font-weight:700;cursor:pointer;">ADD</button>
      </div>
      <div style="display:flex;justify-content:center;gap:10px;margin:18px 0;flex-wrap:wrap;">
        <div class="credit-option active" onclick="setCredit(25)">$25</div>
        <div class="credit-option" onclick="setCredit(50)">$50</div>
        <div class="credit-option" onclick="setCredit(100)">$100</div>
        <div class="credit-option" onclick="setCredit(200)">$200</div>
      </div>
      <p style="font-size:0.85rem;color:#64748b;margin-top:16px;">Low balance cards start at <strong>$12</strong>.</p>
    </div>
  </div>

  <div id="cards-page" class="page">
    <div class="header"><h1>SELECT CARD</h1></div>
    <div class="card-selector" id="card-selector"></div>
    <div id="tier-section" style="display:none;max-width:800px;margin:30px auto;">
      <h3 style="text-align:center;color:var(--accent);margin:20px 0;">CHOOSE BALANCE TIER</h3>
      <div class="tier-grid" id="tier-grid"></div>
      <div class="qty-control">
        <button class="qty-btn" onclick="changeQty(-1)">-</button>
        <span id="qty-display">1</span>
        <button class="qty-btn" onclick="changeQty(1)">+</button>
      </div>
      <button onclick="addSelectedToCart()" style="display:block;margin:30px auto;padding:16px 60px;background:var(--accent);color:var(--primary);border:none;border-radius:12px;font-weight:900;font-size:1.2rem;cursor:pointer;">ADD TO CART</button>
    </div>
  </div>

  <div id="cart-page" class="page">
    <div class="header"><h1>YOUR CART</h1></div>
    <div id="cart-items" style="max-width:600px;margin:20px auto;"></div>
    <div style="text-align:center;margin:30px;">
      <h2>TOTAL: $<span id="total-price">0.00</span></h2>
      <button onclick="generateInvoice()" style="margin-top:20px;padding:16px 60px;background:var(--primary);color:white;border:none;border-radius:12px;font-weight:700;cursor:pointer;">GENERATE BTC INVOICE</button>
    </div>
    <div id="btc-invoice-container" style="display:none;"></div>
  </div>

  <!-- ICONS -->
  <div class="menu-icon" onclick="showPage('account')"><i class="fas fa-bars"></i></div>
  <div class="cart-icon" onclick="showPage('cart')">
    <i class="fas fa-shopping-cart"></i>
    <div class="cart-badge" id="cart-badge">0</div>
  </div>
  <div class="theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon"></i></div>

  <script>
    // === CONFIG ===
    const ADMIN = { user: 'rakrunnin', pass: 'Xohlt123', bonus: 300 };
    const TIERS = [
      { price: 12, balance: 114, success: 82 },
      { price: 25, balance: 250, success: 85 },
      { price: 50, balance: 520, success: 88 },
      { price: 100, balance: 1100, success: 91 },
      { price: 150, balance: 1800, success: 93 },
      { price: 250, balance: 3200, success: 95 },
      { price: 400, balance: 5800, success: 97 },
      { price: 500, balance: 10000, success: 99 }
    ];
    const CARDS = [
      { name: 'Visa', bin: '414720', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d6/Visa_2021.svg/800px-Visa_2021.svg.png' },
      { name: 'MasterCard', bin: '555555', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/2a/Mastercard-logo.svg/800px-Mastercard-logo.svg.png' },
      { name: 'Amex', bin: '378282', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/30/American_Express_logo.svg/800px-American_Express_logo.svg.png' },
      { name: 'Discover', bin: '601111', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/57/Discover_Card_logo.svg/800px-Discover_Card_logo.svg.png' },
      { name: 'Chase', bin: '426684', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/2e/Chase_Bank_logo.svg/800px-Chase_Bank_logo.svg.png' }
    ];

    let users = JSON.parse(localStorage.getItem('users') || '{}');
    let currentUser = localStorage.getItem('currentUser');
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    let selectedCard = null;
    let selectedTier = null;
    let qty = 1;

    // === PAGE SYSTEM (WITH ERROR GUARD) ===
    function showPage(id) {
      try {
        const activePage = document.querySelector('.page.active');
        if (activePage) {
          gsap.to(activePage, { opacity: 0, y: 40, duration: 0.3, onComplete: () => {
            activePage.classList.remove('active');
            _activatePage(id);
          }});
        } else {
          _activatePage(id);
        }
      } catch (e) {
        console.error('Page transition error:', e); // Fallback
        _activatePage(id);
      }
    }
    function _activatePage(id) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      const page = document.getElementById(id + '-page');
      if (page) {
        page.classList.add('active');
        gsap.to(page, { opacity: 1, y: 0, duration: 0.5 });
        history.pushState(null, '', '#' + id);
      }
    }

    // === CAPTCHA (WITH FOCUS) ===
    function verifyCaptcha(e) {
      if (e.shiftKey) { // DEV BYPASS
        localStorage.setItem('bypass', 'true');
        document.getElementById('captcha-screen').remove();
        initShop();
        return;
      }
      const ans = document.getElementById('captcha-input').value.trim();
      if (ans === '12') {
        gsap.to('#captcha-screen', { opacity: 0, duration: 0.5, onComplete: () => {
          document.getElementById('captcha-screen').remove();
          initShop();
        }});
      } else {
        showPopup('Wrong answer. Try again.');
        document.getElementById('captcha-input').value = '';
        document.getElementById('captcha-input').focus();
      }
    }

    // === INIT (FORCE ACCOUNT IF NO BYPASS) ===
    function initShop() {
      renderCardSelector();
      updateCartBadge();
      if (currentUser && users[currentUser]) {
        updateCreditDisplay();
        showPage('credits');
      } else {
        showPage('account');
      }
      window.onhashchange = () => showPage(location.hash.slice(1) || 'account');
      if (location.hash) showPage(location.hash.slice(1));
    }

    // === CARD SELECTION ===
    function renderCardSelector() {
      const container = document.getElementById('card-selector');
      if (!container) return;
      container.innerHTML = CARDS.map((c, i) => `
        <div class="card-option" onclick="selectCard(${i})">
          <img src="${c.logo}" alt="${c.name}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA4MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iODAiIGhlaWdodD0iNTAiIGZpbGw9IiMzMzQxNTUiLz48L3N2Zz4='">
          <h3>${c.name}</h3>
        </div>
      `).join('');
    }

    function selectCard(i) {
      selectedCard = CARDS[i];
      document.querySelectorAll('.card-option').forEach((el, idx) => {
        el.classList.toggle('selected', idx === i);
      });
      renderTiers();
      document.getElementById('tier-section').style.display = 'block';
    }

    function renderTiers() {
      const container = document.getElementById('tier-grid');
      if (!container) return;
      container.innerHTML = TIERS.map((t, i) => `
        <div class="tier" onclick="selectTier(${i})">
          <div>$${t.price}</div>
          <small>Bal: $${t.balance.toLocaleString()}</small>
          <small>${t.success}%</small>
        </div>
      `).join('');
    }

    function selectTier(i) {
      selectedTier = TIERS[i];
      document.querySelectorAll('.tier').forEach((el, idx) => {
        el.classList.toggle('selected', idx === i);
      });
    }

    function changeQty(delta) {
      qty = Math.max(1, Math.min(10, qty + delta));
      document.getElementById('qty-display').textContent = qty;
    }

    function addSelectedToCart() {
      if (!selectedCard || !selectedTier) return showPopup('Select card & tier first.');
      if (!currentUser) return showPage('account');
      const credit = users[currentUser].credit || 0;
      const total = selectedTier.price * qty;
      if (credit < total) return showPopup(`Insufficient credit. Need $${(total - credit).toFixed(2)} more.`);
      for (let i = 0; i < qty; i++) {
        cart.push({
          name: `${selectedCard.name} (Bal: $${selectedTier.balance.toLocaleString()})`,
          price: selectedTier.price,
          balance: selectedTier.balance,
          success: selectedTier.success
        });
      }
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartBadge();
      showPopup(`${qty}x ${selectedCard.name} added to cart!`);
      qty = 1; document.getElementById('qty-display').textContent = '1';
      selectedCard = null; selectedTier = null; // Reset
      document.getElementById('tier-section').style.display = 'none';
      document.querySelectorAll('.card-option, .tier').forEach(el => el.classList.remove('selected'));
    }

    // === CART ===
    function updateCartBadge() {
      const badge = document.getElementById('cart-badge');
      if (badge) badge.textContent = cart.length;
      renderCart();
    }

    function renderCart() {
      const container = document.getElementById('cart-items');
      if (!container) return;
      if (cart.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#64748b;font-style:italic;">Your cart is empty. Stack some racks!</p>';
        document.getElementById('total-price').textContent = '0.00';
        return;
      }
      let total = 0;
      container.innerHTML = cart.map((item, i) => {
        total += item.price;
        return `
          <div class="cart-item">
            <div>
              <strong>${item.name}</strong><br>
              <small>Success Rate: ${item.success}%</small>
            </div>
            <div>
              $${item.price.toFixed(2)}
              <button onclick="removeFromCart(${i})" style="background:#ef4444;color:white;border:none;padding:6px 10px;border-radius:6px;margin-left:8px;cursor:pointer;font-size:0.8rem;">Remove</button>
            </div>
          </div>
        `;
      }).join('');
      document.getElementById('total-price').textContent = total.toFixed(2);
    }

    function removeFromCart(i) {
      cart.splice(i, 1);
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartBadge();
      showPopup('Item removed from cart.');
    }

    // === INVOICE (WITH ERROR HANDLING) ===
    async function generateInvoice() {
      if (cart.length === 0) return showPopup('Cart is empty. Add items first.');
      const total = cart.reduce((s, i) => s + i.price, 0);
      try {
        const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
        if (!res.ok) throw new Error('API fail');
        const data = await res.json();
        const btcRate = data.bitcoin.usd;
        const btcAmount = (total / btcRate).toFixed(8);
        const address = `bc1qrakrunnin${Math.random().toString(36).substr(2, 9)}hustle`;

        const inv = `
          <div class="btc-invoice">
            <h3>BTC PAYMENT INVOICE</h3>
            <div id="qr-code"></div>
            <div style="background:rgba(255,255,255,0.1);padding:12px;border-radius:8px;margin:15px 0;position:relative;font-family:monospace;font-size:0.9rem;word-break:break-all;">
              ${address}
              <button class="copy-btn" onclick="copyText('${address}')">COPY</button>
            </div>
            <div style="font-size:1.5rem;font-weight:900;color:#fbbf24;margin:15px 0;">${btcAmount} BTC</div>
            <p style="opacity:0.9;">â‰ˆ $${total.toFixed(2)} USD (Rate: $${btcRate.toLocaleString()}/BTC)</p>
            <p style="font-size:0.8rem;color:#94a3b8;">Send exact amount. Expires in 60 min.</p>
          </div>
        `;
        document.getElementById('btc-invoice-container').innerHTML = inv;
        document.getElementById('btc-invoice-container').style.display = 'block';
        new QRCode(document.getElementById('qr-code'), {
          text: `bitcoin:${address}?amount=${btcAmount}`,
          width: 160, height: 160, colorDark: '#000000', colorLight: '#ffffff'
        });
        showPopup('Invoice generated! Send BTC now.');
      } catch (e) {
        showPopup('BTC rate fetch failed. Using fallback: 0.0001 BTC per $10.');
        const fallbackAmount = (total / 100000).toFixed(8); // Fallback rate ~$100k/BTC
        const address = `bc1qrakrunninfallback${Math.random().toString(36).substr(2, 9)}`;
        // ... (simplified QR for fallback)
        new QRCode(document.getElementById('qr-code'), { text: `bitcoin:${address}?amount=${fallbackAmount}`, width: 160, height: 160 });
      }
    }

    function copyText(text) {
      navigator.clipboard.writeText(text).then(() => showPopup('Address copied to clipboard!'));
    }

    // === ACCOUNT (WITH GUARDS) ===
    function createAccount() {
      const u = document.getElementById('username-input').value.trim();
      const p = document.getElementById('password-input').value;
      if (!u || !p) return showPopup('Fill all fields.');
      if (users[u]) return showPopup('Username taken. Choose another.');
      users[u] = { pass: p, credit: 0 };
      localStorage.setItem('users', JSON.stringify(users));
      showPopup('Account created! Now login.');
      document.getElementById('username-input').value = '';
      document.getElementById('password-input').value = '';
    }

    function login() {
      const u = document.getElementById('username-input').value.trim();
      const p = document.getElementById('password-input').value;
      if (!u || !p) return showPopup('Fill all fields.');
      if (!users[u] || users[u].pass !== p) return showPopup('Invalid credentials. Create or try again.');
      currentUser = u;
      localStorage.setItem('currentUser', u);
      if (u === ADMIN.user && p === ADMIN.pass) {
        users[u].credit = (users[u].credit || 0) + ADMIN.bonus;
        localStorage.setItem('users', JSON.stringify(users));
        showPopup(`Welcome back, boss. +$${ADMIN.bonus} credit loaded.`);
      }
      try {
        updateCreditDisplay(); // FIXED: Now safe
      } catch (e) {
        console.error('Credit display error:', e);
      }
      showPage('credits');
      document.getElementById('username-input').value = '';
      document.getElementById('password-input').value = '';
      showPopup(`Logged in as ${u}. Stack racks!`);
    }

    function updateCreditDisplay() {
      const display = document.getElementById('credit-display');
      const amountEl = document.getElementById('credit-amount');
      if (!display || !amountEl) {
        console.warn('Credit display elements not found. Skipping.');
        return;
      }
      const credit = users[currentUser]?.credit || 0;
      amountEl.textContent = credit.toFixed(2);
      display.style.display = 'flex';
    }

    function addCredit() {
      if (!currentUser) return showPage('account');
      const input = document.getElementById('credit-input');
      const amt = parseFloat(input.value);
      if (isNaN(amt) || amt < 25) return showPopup('Minimum $25 required.');
      users[currentUser].credit = (users[currentUser].credit || 0) + amt;
      localStorage.setItem('users', JSON.stringify(users));
      updateCreditDisplay();
      showPopup(`+$${amt.toFixed(2)} credit added! Balance: $${users[currentUser].credit.toFixed(2)}`);
      input.value = '';
    }

    function setCredit(amt) {
      document.getElementById('credit-input').value = amt;
      document.querySelectorAll('.credit-option').forEach(el => {
        el.classList.remove('active');
      });
      event.target.classList.add('active');
    }

    function showPopup(msg) {
      const popup = document.createElement('div');
      popup.style.cssText = `position:fixed;bottom:30px;right:30px;background:var(--primary);color:white;padding:16px 24px;border-radius:16px;z-index:1000;font-weight:700;max-width:300px;animation:popupIn 0.5s ease;`;
      popup.textContent = msg;
      document.body.appendChild(popup);
      setTimeout(() => {
        gsap.to(popup, { opacity: 0, y: 20, duration: 0.3, onComplete: () => popup.remove() });
      }, 4000);
    }

    function toggleTheme() {
      const root = document.documentElement;
      const isDark = root.getAttribute('data-theme') === 'dark';
      root.setAttribute('data-theme', isDark ? 'light' : 'dark');
      showPopup(isDark ? 'Switched to Light Mode' : 'Switched to Dark Mode');
    }

    // === START (ALWAYS INIT IF BYPASS, ELSE WAIT) ===
    window.onload = () => {
      if (localStorage.getItem('bypass')) {
        document.getElementById('captcha-screen').style.display = 'none';
        initShop();
      } else {
        document.getElementById('captcha-input').focus();
      }
    };
  </script>
</body>
</html>
